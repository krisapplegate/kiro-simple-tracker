name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: location_tracker_test
          POSTGRES_USER: tracker_user
          POSTGRES_PASSWORD: tracker_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests
      run: npm run test:unit
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-key-for-ci
    
    - name: Install PostgreSQL client
      run: sudo apt-get update && sudo apt-get install -y postgresql-client
    
    - name: Wait for PostgreSQL
      run: |
        timeout 30 bash -c 'until pg_isready -h localhost -p 5432 -U tracker_user; do sleep 1; done'
      env:
        PGPASSWORD: tracker_password
    
    - name: Setup test database
      run: |
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -f database/init.sql
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -f database/migrate_add_created_by.sql
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -f database/migrate_add_object_type_configs.sql
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -f database/migrate_add_rbac.sql
      env:
        PGPASSWORD: tracker_password
    
    - name: Start backend server
      run: |
        npm run dev:backend &
        BACKEND_PID=$!
        echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV
        
        # Wait for backend to be ready
        echo "Waiting for backend to start..."
        for i in {1..30}; do
          if curl -f http://localhost:3001/api/health 2>/dev/null; then
            echo "âœ… Backend is ready!"
            break
          fi
          echo "Attempt $i/30: Backend not ready yet, waiting..."
          sleep 2
        done
        
        # Final check
        if ! curl -f http://localhost:3001/api/health 2>/dev/null; then
          echo "âŒ Backend failed to start after 60 seconds"
          exit 1
        fi
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-key-for-ci
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: location_tracker_test
        DB_USER: tracker_user
        DB_PASSWORD: tracker_password
    
    - name: Verify database setup
      run: |
        echo "Checking database tables..."
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -c "\dt"
        echo "Checking admin user exists..."
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -c "SELECT email, role FROM users WHERE email = 'admin@demo.com';"
        echo "Checking roles exist..."
        PGPASSWORD=tracker_password psql -h localhost -U tracker_user -d location_tracker_test -c "SELECT name, display_name FROM roles LIMIT 5;"
      env:
        PGPASSWORD: tracker_password
    
    - name: Test admin login
      run: |
        echo "Testing admin login..."
        curl -X POST http://localhost:3001/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"email":"admin@demo.com","password":"password"}' \
          -v || echo "Admin login failed"
        
        echo "Testing /api/users endpoint..."
        TOKEN=$(curl -s -X POST http://localhost:3001/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"email":"admin@demo.com","password":"password"}' | jq -r '.token')
        
        if [ "$TOKEN" != "null" ] && [ "$TOKEN" != "" ]; then
          echo "âœ… Got admin token: ${TOKEN:0:20}..."
          curl -X GET http://localhost:3001/api/users \
            -H "Authorization: Bearer $TOKEN" \
            -v || echo "Users endpoint failed"
        else
          echo "âŒ Failed to get admin token"
        fi
    
    - name: Run API integration tests
      run: |
        echo "Starting integration tests..."
        echo "Backend PID: $BACKEND_PID"
        echo "Testing backend health before tests..."
        curl -f http://localhost:3001/api/health || echo "Backend health check failed"
        
        echo "Running simple integration tests first..."
        timeout 120 npm run test:api:simple || {
          echo "Simple tests failed or timed out"
          echo "Checking backend status..."
          ps aux | grep node || echo "No node processes found"
          curl -f http://localhost:3001/api/health || echo "Backend not responding"
          exit 1
        }
        
        echo "Simple tests passed, running full test suite..."
        timeout 300 npm run test:api || {
          echo "Full tests timed out or failed"
          exit 1
        }
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-key-for-ci
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: location_tracker_test
        DB_USER: tracker_user
        DB_PASSWORD: tracker_password
    
    - name: Check JavaScript syntax
      run: |
        echo "Checking JavaScript syntax..."
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./coverage/*" -exec node -c {} \;
        echo "âœ… All JavaScript files have valid syntax"
    
    - name: Run security audit
      run: npm audit --audit-level moderate
      continue-on-error: true
    
    - name: Stop backend server
      if: always()
      run: |
        if [ ! -z "$BACKEND_PID" ]; then
          kill $BACKEND_PID || true
          echo "Backend server stopped"
        fi
    
    - name: Test Summary
      if: always()
      run: |
        echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Unit tests completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… API integration tests completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Syntax validation completed" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Security audit completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY